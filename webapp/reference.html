<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reference Image - NPSketch</title>
    
    <!-- Global Common Styles -->
    <link rel="stylesheet" href="/css/common.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .workspace {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }
        
        /* Responsive Design for narrow screens */
        @media (max-width: 1024px) {
            .workspace {
                grid-template-columns: 1fr;
            }
        }
        
        .canvas-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .canvas-wrapper {
            position: relative;
            width: 568px;
            height: 274px;
            margin: 0 auto;
            border: 3px solid #667eea;
            cursor: crosshair;
        }
        
        #referenceImage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .line-type-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .line-type-selector {
                grid-template-columns: 1fr;
            }
        }
        
        .type-btn {
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .type-btn.active {
            border-width: 3px;
            transform: scale(1.05);
        }
        
        .type-btn.horizontal {
            border-color: #28a745;
            color: #28a745;
        }
        
        .type-btn.horizontal.active {
            background: #28a745;
            color: white;
        }
        
        .type-btn.vertical {
            border-color: #007bff;
            color: #007bff;
        }
        
        .type-btn.vertical.active {
            background: #007bff;
            color: white;
        }
        
        .type-btn.diagonal {
            border-color: #fd7e14;
            color: #fd7e14;
        }
        
        .type-btn.diagonal.active {
            background: #fd7e14;
            color: white;
        }
        
        .features-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 10px;
        }
        
        .feature-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feature-item.horizontal { border-left-color: #28a745; }
        .feature-item.vertical { border-left-color: #007bff; }
        .feature-item.diagonal { border-left-color: #fd7e14; }
        
        .delete-icon {
            cursor: pointer;
            color: #dc3545;
            font-size: 1.2em;
            padding: 4px;
        }
        
        .delete-icon:hover {
            transform: scale(1.2);
        }
        
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .counter {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .counter-item {
            text-align: center;
        }
        
        .counter-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .counter-label {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/index.html" class="back-link">‚Üê Main</a>
        
        <h1>üìê Reference Image - Feature Editor</h1>
        
        <div id="statusBar" class="status info">
            Lade Reference Image...
        </div>
        
        <div class="workspace">
            <div class="canvas-section">
                <div class="canvas-wrapper">
                    <img id="referenceImage" />
                    <canvas id="canvas" width="568" height="274"></canvas>
                </div>
                
                <div class="counter">
                    <div class="counter-item">
                        <div class="counter-value" id="totalCount">0</div>
                        <div class="counter-label">Total</div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-value" id="hCount" style="color: #28a745;">0</div>
                        <div class="counter-label">H</div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-value" id="vCount" style="color: #007bff;">0</div>
                        <div class="counter-label">V</div>
                    </div>
                    <div class="counter-item">
                        <div class="counter-value" id="dCount" style="color: #fd7e14;">0</div>
                        <div class="counter-label">D</div>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <div class="section">
                    <h3>Feature erstellen</h3>
                    <button class="btn btn-primary" id="createBtn" onclick="toggleCreateMode()">
                        ‚ûï Create Feature
                    </button>
                    <p style="font-size: 0.85em; color: #666; margin-top: 10px;" id="instructionText">
                        Klicke "Create Feature" und dann 2 Punkte im Bild<br>
                        <small style="color: #999;">Typ wird automatisch erkannt: üü¢ H, üîµ V, üü† D</small>
                    </p>
                </div>
                
                <div class="section">
                    <h3>Features (<span id="featureCount">0</span>)</h3>
                    <div class="features-list" id="featuresList"></div>
                </div>
                
                <div class="section">
                    <button class="btn btn-success" onclick="finalizeReference()" id="finalizeBtn" disabled>
                        ‚úÖ Finalize Reference
                    </button>
                    <button class="btn btn-danger" onclick="clearAllFeatures()">
                        üóëÔ∏è Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const img = document.getElementById('referenceImage');
        
        let features = [];
        let createMode = false;
        let firstPoint = null;
        let referenceId = null;
        
        const colors = {
            horizontal: '#28a745',
            vertical: '#007bff',
            diagonal: '#fd7e14'
        };
        
        // Auto-detect line type based on angle
        function detectLineType(x1, y1, x2, y2) {
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            const normAngle = Math.abs(angle) <= 90 ? Math.abs(angle) : 180 - Math.abs(angle);
            
            if (normAngle < 15) return 'horizontal';
            if (normAngle > 75) return 'vertical';
            return 'diagonal';
        }
        
        // Load reference image
        async function loadReference() {
            try {
                const response = await fetch('/api/references');
                const refs = await response.json();
                
                if (refs.length === 0) {
                    showStatus('‚ö†Ô∏è Kein Reference Image gefunden!', 'warning');
                    return;
                }
                
                referenceId = refs[0].id;
                img.src = `/api/references/${referenceId}/image`;
                
                img.onload = () => {
                    loadFeatures();
                    showStatus('‚úì Reference Image geladen - Beginne Feature-Erstellung', 'info');
                };
            } catch (error) {
                showStatus('‚ùå Fehler beim Laden: ' + error.message, 'warning');
            }
        }
        
        async function loadFeatures() {
            try {
                const response = await fetch('/api/references');
                const refs = await response.json();
                
                if (refs.length > 0 && refs[0].feature_data) {
                    const data = JSON.parse(refs[0].feature_data);
                    features = data.lines || [];
                } else {
                    features = [];
                }
                
                redrawCanvas();
                updateUI();
            } catch (error) {
                console.error('Error loading features:', error);
                features = [];
                redrawCanvas();
                updateUI();
            }
        }
        
        function toggleCreateMode() {
            createMode = !createMode;
            const btn = document.getElementById('createBtn');
            const instruction = document.getElementById('instructionText');
            
            if (createMode) {
                btn.textContent = '‚ùå Cancel';
                btn.style.background = '#dc3545';
                instruction.innerHTML = 'Klicke 2 Punkte im Bild (Start ‚Üí End)<br><small style="color: #999;">Typ wird automatisch erkannt: üü¢ H, üîµ V, üü† D</small>';
                instruction.style.color = '#667eea';
                instruction.style.fontWeight = 'bold';
            } else {
                btn.textContent = '‚ûï Create Feature';
                btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                instruction.innerHTML = 'Klicke "Create Feature" und dann 2 Punkte im Bild<br><small style="color: #999;">Typ wird automatisch erkannt: üü¢ H, üîµ V, üü† D</small>';
                instruction.style.color = '#666';
                instruction.style.fontWeight = 'normal';
                firstPoint = null;
                redrawCanvas();
            }
        }
        
        canvas.addEventListener('click', async (e) => {
            if (!createMode) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = Math.round((e.clientX - rect.left) * (568 / rect.width));
            const y = Math.round((e.clientY - rect.top) * (274 / rect.height));
            
            if (!firstPoint) {
                firstPoint = {x, y};
                // Temporary gray point
                drawPoint(x, y, '#999');
            } else {
                // Auto-detect type and create feature
                const lineType = detectLineType(firstPoint.x, firstPoint.y, x, y);
                await createFeature(firstPoint, {x, y}, lineType);
                firstPoint = null;
                toggleCreateMode();
            }
        });
        
        async function createFeature(start, end, type) {
            try {
                const response = await fetch('/api/reference/features', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: type,
                        start: start,
                        end: end
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Reload features to get updated data
                    await loadFeatures();
                    
                    // Force redraw
                    redrawCanvas();
                    updateUI();
                    
                    const typeEmoji = type === 'horizontal' ? 'üü¢' : type === 'vertical' ? 'üîµ' : 'üü†';
                    const typeName = type === 'horizontal' ? 'Horizontal' : type === 'vertical' ? 'Vertikal' : 'Diagonal';
                    
                    showStatus(`‚úì ${typeEmoji} ${typeName} Feature erstellt! Total: ${result.total_features}`, 'success');
                    
                    setTimeout(() => {
                        showStatus(`Features: ${result.total_features} | üü¢ ${result.line_counts.horizontal} üîµ ${result.line_counts.vertical} üü† ${result.line_counts.diagonal}`, 'info');
                    }, 2000);
                } else {
                    showStatus('‚ùå Fehler beim Erstellen', 'warning');
                }
            } catch (error) {
                showStatus('‚ùå Fehler: ' + error.message, 'warning');
            }
        }
        
        async function deleteFeature(index) {
            if (!confirm('Feature l√∂schen?')) return;
            
            try {
                const response = await fetch(`/api/reference/features/${index}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadFeatures();
                    showStatus('‚úì Feature gel√∂scht', 'success');
                } else {
                    showStatus('‚ùå Fehler beim L√∂schen', 'warning');
                }
            } catch (error) {
                showStatus('‚ùå Fehler: ' + error.message, 'warning');
            }
        }
        
        function drawPoint(x, y, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        }
        
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            features.forEach((line, idx) => {
                const angle = Math.atan2(line[3] - line[1], line[2] - line[0]) * 180 / Math.PI;
                const norm = Math.abs(angle) <= 90 ? Math.abs(angle) : 180 - Math.abs(angle);
                
                let color;
                if (norm < 15) color = colors.horizontal;
                else if (norm > 75) color = colors.vertical;
                else color = colors.diagonal;
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(line[0], line[1]);
                ctx.lineTo(line[2], line[3]);
                ctx.stroke();
                
                drawPoint(line[0], line[1], color);
                drawPoint(line[2], line[3], color);
                
                // Label
                const midX = (line[0] + line[2]) / 2;
                const midY = (line[1] + line[3]) / 2;
                ctx.fillStyle = 'white';
                ctx.fillRect(midX - 10, midY - 10, 20, 20);
                ctx.fillStyle = 'black';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(idx + 1, midX, midY + 5);
            });
            
            if (firstPoint) {
                drawPoint(firstPoint.x, firstPoint.y, '#999');
            }
        }
        
        function updateUI() {
            // Update list
            const list = document.getElementById('featuresList');
            list.innerHTML = '';
            
            let h = 0, v = 0, d = 0;
            
            if (!features || features.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px; font-size: 0.9em;">Noch keine Features<br>Klicke "Create Feature" um zu starten</p>';
            } else {
                features.forEach((line, idx) => {
                    const angle = Math.atan2(line[3] - line[1], line[2] - line[0]) * 180 / Math.PI;
                    const norm = Math.abs(angle) <= 90 ? Math.abs(angle) : 180 - Math.abs(angle);
                    
                    let type, typeLabel;
                    if (norm < 15) { 
                        type = 'horizontal'; 
                        typeLabel = 'üü¢ H';
                        h++; 
                    } else if (norm > 75) { 
                        type = 'vertical'; 
                        typeLabel = 'üîµ V';
                        v++; 
                    } else { 
                        type = 'diagonal'; 
                        typeLabel = 'üü† D';
                        d++; 
                    }
                    
                    const div = document.createElement('div');
                    div.className = `feature-item ${type}`;
                    div.innerHTML = `
                        <span>
                            <strong>#${idx + 1}</strong> ${typeLabel}<br>
                            <small>(${line[0]},${line[1]}) ‚Üí (${line[2]},${line[3]})</small>
                        </span>
                        <span class="delete-icon" onclick="deleteFeature(${idx})">üóëÔ∏è</span>
                    `;
                    list.appendChild(div);
                });
            }
            
            // Update counters
            const totalCount = features ? features.length : 0;
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('hCount').textContent = h;
            document.getElementById('vCount').textContent = v;
            document.getElementById('dCount').textContent = d;
            document.getElementById('featureCount').textContent = totalCount;
            
            // Update finalize button
            document.getElementById('finalizeBtn').disabled = totalCount < 6;
        }
        
        async function clearAllFeatures() {
            if (!confirm('Alle Features l√∂schen?')) return;
            
            try {
                // Delete reference completely to reset everything
                const response = await fetch('/api/reference/clear', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    features = [];
                    redrawCanvas();
                    updateUI();
                    showStatus('‚úì Alle Features gel√∂scht - Nummerierung zur√ºckgesetzt', 'success');
                } else {
                    showStatus('‚ùå Fehler beim L√∂schen', 'warning');
                }
            } catch (error) {
                showStatus('‚ùå Fehler: ' + error.message, 'warning');
            }
        }
        
        function finalizeReference() {
            showStatus('‚úÖ Reference erfolgreich erstellt! Weiterleitung...', 'success');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('statusBar');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        // Initialize
        loadReference();
    </script>
</body>
</html>
