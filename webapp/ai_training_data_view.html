<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPSketch - View Training Data</title>
    
    <!-- Global Common Styles (ALL pages) -->
    <link rel="stylesheet" href="/css/common.css">
    
    <!-- AI Training Specific Styles -->
    <link rel="stylesheet" href="/css/ai_training_common.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        /* back-link style from common.css */
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 8px;
            font-size: 0.95em;
        }
        
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
        }
        
        /* Data Table */
        .data-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-row {
            display: grid;
            grid-template-columns: 60px 150px 100px 100px 100px 120px 100px 120px 1fr 50px;
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
            align-items: center;
        }
        
        .data-row:hover:not(.header) {
            background: #f8f9fa;
        }
        
        .data-row.header {
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        .data-row.header .data-cell {
            display: flex;
            align-items: center;
            gap: 5px;
            user-select: none;
        }
        
        .data-row.header .data-cell:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sort-icon {
            font-size: 0.8em;
            opacity: 0.5;
        }
        
        .sort-icon.active {
            opacity: 1;
        }
        
        .data-cell {
            font-size: 0.9em;
            color: #495057;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .data-row.header .data-cell {
            color: white;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge.mat {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge.ocs {
            background: #d4edda;
            color: #155724;
        }
        
        .badge.drawn {
            background: #e7e3ff;
            color: #5a3d99;
        }
        
        .badge.upload {
            background: #cfe2ff;
            color: #084298;
        }
        
        .badge.copy {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge.recall {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge.undefined {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .badge.has-features {
            background: #d4edda;
            color: #155724;
        }
        
        .badge.missing-features {
            background: #f8d7da;
            color: #721c24;
            font-weight: 700;
        }
        
        .delete-icon {
            cursor: pointer;
            font-size: 18px;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s;
            opacity: 0.6;
            text-align: center;
        }
        
        .delete-icon:hover {
            opacity: 1;
            background: #ffebee;
            transform: scale(1.2);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            color: white;
        }
        
        .modal-close:hover {
            background: #c82333;
        }
        
        .modal-header h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .modal-images {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }
        
        .modal-images-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .modal-image-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .modal-image-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .modal-image-section h4 {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 8px;
        }
        
        .modal-image-section img {
            width: 100%;
            border-radius: 6px;
            background: white;
            padding: 10px;
        }
        
        .image-meta {
            margin-top: 10px;
            color: #666;
            font-size: 0.9em;
        }
        
        .image-meta p {
            margin: 5px 0;
        }
        
        .feature-editor {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .feature-editor h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .feature-list {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin: 15px 0;
        }
        
        .feature-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .feature-item:last-child {
            border-bottom: none;
        }
        
        .feature-key {
            font-weight: 600;
            color: #495057;
        }
        
        .feature-value {
            color: #667eea;
            font-weight: 600;
        }
        
        .feature-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .feature-input-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
        }
        
        .feature-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination span {
            color: #666;
            font-weight: 600;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .alert.success {
            background: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container hexagon-pattern">
        <a href="/index.html" class="back-link">‚Üê Main</a>
        
        <h1>üìä View Training Data</h1>
        <p class="subtitle">Browse and manage uploaded AI training images</p>
        
        <div class="alert" id="alert"></div>
        
        <!-- Statistics Dashboard -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalImages">-</div>
                <div class="stat-label">Total Images</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="matCount">-</div>
                <div class="stat-label">MAT Drawings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ocsCount">-</div>
                <div class="stat-label">OCS Ratings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="patientCount">-</div>
                <div class="stat-label">Patients</div>
            </div>
        </div>
        
        <!-- Bulk Features Section -->
        <div class="section">
            <h2>üìä Bulk Feature Management</h2>
            <p style="color: #666; margin-bottom: 15px;">Download template, fill in features, and upload to update multiple entries at once.</p>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <a href="/api/training-data-features-template" class="btn btn-small" download>
                    üì• Download CSV Template
                </a>
                <button class="btn btn-small" onclick="document.getElementById('csvFileInput').click()" style="background: #28a745;">
                    üì§ Upload Feature Table
                </button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="uploadFeatureCSV()">
            </div>
            <div id="csvUploadResult" style="margin-top: 15px;"></div>
        </div>
        
        <!-- Data Table -->
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 20px; flex-wrap: wrap;">
                <h2 style="margin: 0;">Training Data Images</h2>
                <div style="display: flex; gap: 10px; flex: 1; max-width: 700px; align-items: center;">
                    <div id="resultCount" style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em; white-space: nowrap;">
                        0 items
                    </div>
                    <label style="display: flex; align-items: center; gap: 6px; background: #fff3cd; padding: 6px 12px; border-radius: 6px; cursor: pointer; white-space: nowrap; font-size: 0.9em;">
                        <input type="checkbox" id="filterMissing" onchange="searchData()" style="cursor: pointer;">
                        <span style="color: #856404; font-weight: 600;">Only Missing</span>
                    </label>
                    <input type="text" 
                           id="searchInput" 
                           placeholder="üîç Search ID, Patient, Task, Source, Date..." 
                           style="flex: 1; padding: 10px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 0.95em;"
                           oninput="searchData()">
                    <button class="btn btn-secondary btn-small" onclick="clearSearch()" style="white-space: nowrap;">Clear</button>
                </div>
                <a href="/ai_training_data_upload.html" class="btn btn-small" style="white-space: nowrap;">‚ûï Add New Data</a>
            </div>
            
            <div class="data-table">
                <div class="data-row header">
                    <div class="data-cell" onclick="sortBy('id')">
                        <span>ID</span>
                        <span class="sort-icon" id="sort-id">‚Üï</span>
                    </div>
                    <div class="data-cell" onclick="sortBy('patient')">
                        <span>Patient</span>
                        <span class="sort-icon" id="sort-patient">‚Üï</span>
                    </div>
                    <div class="data-cell" onclick="sortBy('task')">
                        <span>Task</span>
                        <span class="sort-icon" id="sort-task">‚Üï</span>
                    </div>
                    <div class="data-cell" onclick="sortBy('source')">
                        <span>Source</span>
                        <span class="sort-icon" id="sort-source">‚Üï</span>
                    </div>
                    <div class="data-cell" onclick="sortBy('resolution')">
                        <span>Resolution</span>
                        <span class="sort-icon" id="sort-resolution">‚Üï</span>
                    </div>
                    <div class="data-cell" onclick="sortBy('date')">
                        <span>Date</span>
                        <span class="sort-icon" id="sort-date">‚Üï</span>
                    </div>
                    <div class="data-cell" onclick="sortBy('features')">
                        <span>Features</span>
                        <span class="sort-icon" id="sort-features">‚Üï</span>
                    </div>
                    <div class="data-cell" onclick="sortBy('ground_truth')">
                        <span>Lines</span>
                        <span class="sort-icon" id="sort-ground_truth">‚Üï</span>
                    </div>
                    <div class="data-cell" onclick="sortBy('filename')">
                        <span>Original File</span>
                        <span class="sort-icon" id="sort-filename">‚Üï</span>
                    </div>
                    <div class="data-cell" style="cursor: default;">
                        <span></span>
                    </div>
                </div>
                <div id="dataRows"></div>
            </div>
            
            <div class="pagination">
                <button onclick="changePage(-1)" id="prevBtn">‚Üê Previous</button>
                <span id="pageInfo">Page 1</span>
                <button onclick="changePage(1)" id="nextBtn">Next ‚Üí</button>
                <span style="margin-left: 20px; color: #666;">|</span>
                <span style="color: #666; margin-left: 20px;">Items per page:</span>
                <select onchange="changePageSize(this.value)" id="pageSizeSelect" style="padding: 6px 12px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer; margin-left: 8px;">
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span id="itemsInfo" style="margin-left: 20px; color: #666; font-size: 0.95em;"></span>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="modal" id="previewModal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <p style="color: #666;" id="modalSubtitle"></p>
            </div>
            <div class="modal-images" id="modalImages"></div>
        </div>
    </div>
    
    <script>
        let existingData = [];
        let allData = [];  // Store all loaded data for client-side search
        let currentPage = 0;
        let totalPages = 0;
        let pageSize = 25;  // Show 25 items per page (can be changed by user)
        let searchTerm = '';
        let sortColumn = 'id';
        let sortDirection = 'desc';  // 'asc' or 'desc'
        
        async function loadData() {
            try {
                // Load all data for client-side search and filtering (limit to 1000)
                let url = `/api/training-data-images?limit=1000&offset=0`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                allData = data.images;  // Store all data for search
                existingData = filterBySearch(allData);
                
                // Apply current sort
                sortData();
                
                totalPages = Math.ceil(existingData.length / pageSize);
                
                await updateStatistics();
                updateResultCount();
                updateSortIcons();
                renderDataTable(getPaginatedData());
                updatePagination();
                
            } catch (error) {
                showAlert('error', `Error loading data: ${error.message}`);
            }
        }
        
        async function updateStatistics() {
            try {
                const response = await fetch('/api/training-data-images?limit=10000');
                const data = await response.json();
                
                const matCount = data.images.filter(img => img.source_format === 'MAT').length;
                const ocsCount = data.images.filter(img => img.source_format === 'OCS').length;
                const patients = new Set(data.images.map(img => img.patient_id)).size;
                
                document.getElementById('totalImages').textContent = data.total;
                document.getElementById('matCount').textContent = matCount;
                document.getElementById('ocsCount').textContent = ocsCount;
                document.getElementById('patientCount').textContent = patients;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        function filterBySearch(images) {
            let filtered = images;
            
            // Filter by "Only Missing" checkbox
            const onlyMissing = document.getElementById('filterMissing').checked;
            if (onlyMissing) {
                filtered = filtered.filter(img => !img.has_features);
            }
            
            // Filter by search term
            if (searchTerm && searchTerm.trim() !== '') {
                const term = searchTerm.toLowerCase();
                
                filtered = filtered.filter(img => {
                    // Search across: ID, Patient, Task, Source, Original filename, Date
                    const id = img.id.toString();
                    const patient = img.patient_id.toLowerCase();
                    const task = img.task_type.toLowerCase();
                    const source = img.source_format.toLowerCase();
                    const filename = img.original_filename.toLowerCase();
                    const date = new Date(img.uploaded_at).toLocaleDateString().toLowerCase();
                    
                    return id.includes(term) ||
                           patient.includes(term) ||
                           task.includes(term) ||
                           source.includes(term) ||
                           filename.includes(term) ||
                           date.includes(term);
                });
            }
            
            return filtered;
        }
        
        function getFilteredData() {
            return existingData;  // existingData already contains the filtered results
        }
        
        function getPaginatedData() {
            const start = currentPage * pageSize;
            const end = start + pageSize;
            return existingData.slice(start, end);
        }
        
        function updateResultCount() {
            const count = existingData.length;
            const countElement = document.getElementById('resultCount');
            countElement.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;
            
            // Change color if filtered
            if (searchTerm && searchTerm.trim() !== '') {
                countElement.style.background = '#28a745';  // Green when searching
            } else {
                countElement.style.background = '#667eea';  // Default blue
            }
        }
        
        function searchData() {
            searchTerm = document.getElementById('searchInput').value;
            currentPage = 0;  // Reset to first page on search
            existingData = filterBySearch(allData);
            totalPages = Math.ceil(existingData.length / pageSize);
            updateResultCount();
            renderDataTable(getPaginatedData());
            updatePagination();
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterMissing').checked = false;
            searchData();
        }
        
        function sortData() {
            // Sort existingData based on current sortColumn and sortDirection
            existingData.sort((a, b) => {
                let valA, valB;
                
                switch(sortColumn) {
                    case 'id':
                        valA = a.id;
                        valB = b.id;
                        break;
                    case 'patient':
                        valA = a.patient_id.toLowerCase();
                        valB = b.patient_id.toLowerCase();
                        break;
                    case 'task':
                        valA = a.task_type.toLowerCase();
                        valB = b.task_type.toLowerCase();
                        break;
                    case 'source':
                        valA = a.source_format.toLowerCase();
                        valB = b.source_format.toLowerCase();
                        break;
                    case 'resolution':
                        valA = a.width * a.height;
                        valB = b.width * b.height;
                        break;
                    case 'filename':
                        valA = a.original_filename.toLowerCase();
                        valB = b.original_filename.toLowerCase();
                        break;
                    case 'date':
                        valA = new Date(a.uploaded_at).getTime();
                        valB = new Date(b.uploaded_at).getTime();
                        break;
                    case 'features':
                        valA = a.has_features ? 1 : 0;
                        valB = b.has_features ? 1 : 0;
                        break;
                    case 'ground_truth':
                        valA = (a.ground_truth_correct || 0) + (a.ground_truth_extra || 0);
                        valB = (b.ground_truth_correct || 0) + (b.ground_truth_extra || 0);
                        break;
                    default:
                        return 0;
                }
                
                // Compare
                let comparison = 0;
                if (valA < valB) comparison = -1;
                if (valA > valB) comparison = 1;
                
                // Apply direction
                return sortDirection === 'asc' ? comparison : -comparison;
            });
        }
        
        function sortBy(column) {
            // Toggle direction if same column, otherwise default to desc
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'desc';
            }
            
            // Sort and update UI
            sortData();
            updateSortIcons();
            currentPage = 0;  // Reset to first page
            renderDataTable(getPaginatedData());
            updatePagination();
        }
        
        function updateSortIcons() {
            // Reset all icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.classList.remove('active');
                icon.textContent = '‚Üï';
            });
            
            // Set active icon
            const activeIcon = document.getElementById(`sort-${sortColumn}`);
            if (activeIcon) {
                activeIcon.classList.add('active');
                activeIcon.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
            }
        }
        
        function renderDataTable(images) {
            const container = document.getElementById('dataRows');
            
            if (images.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No training data found</h3>
                        <p>Upload some files to get started</p>
                        <a href="/ai_training_data_upload.html" class="btn" style="display: inline-block; margin-top: 20px;">‚ûï Add New Data</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = images.map((img, pageIndex) => {
                // Find real index in existingData for correct preview
                const realIndex = existingData.findIndex(item => item.id === img.id);
                
                const date = new Date(img.uploaded_at).toLocaleDateString();
                const shortFilename = img.original_filename.length > 30 
                    ? img.original_filename.substring(0, 27) + '...' 
                    : img.original_filename;
                
                const featuresBadge = img.has_features 
                    ? '<span class="badge has-features">‚úì Set</span>'
                    : '<span class="badge missing-features">MISSING</span>';
                
                const hasGroundTruth = (img.ground_truth_correct !== null && img.ground_truth_correct !== undefined) || 
                                       (img.ground_truth_extra !== null && img.ground_truth_extra !== undefined);
                const groundTruthDisplay = hasGroundTruth
                    ? `<span style="color: #28a745;">‚úì${img.ground_truth_correct || 0}</span> / <span style="color: #ffc107;">‚úó${img.ground_truth_extra || 0}</span>`
                    : '<span class="badge missing-features">‚Äî</span>';
                
                return `
                    <div class="data-row" onclick="showPreview(${realIndex})">
                        <div class="data-cell">${img.id}</div>
                        <div class="data-cell">${img.patient_id}</div>
                        <div class="data-cell"><span class="badge ${img.task_type.toLowerCase()}">${img.task_type}</span></div>
                        <div class="data-cell"><span class="badge ${img.source_format.toLowerCase()}">${img.source_format}</span></div>
                        <div class="data-cell" style="font-size: 0.8em;">${img.width}√ó${img.height}</div>
                        <div class="data-cell">${date}</div>
                        <div class="data-cell">${featuresBadge}</div>
                        <div class="data-cell" style="font-size: 0.9em;">${groundTruthDisplay}</div>
                        <div class="data-cell" style="font-size: 0.8em;" title="${img.original_filename}">${shortFilename}</div>
                        <div class="data-cell">
                            <span class="delete-icon" onclick="event.stopPropagation(); deleteImage(${img.id}, '${img.patient_id}')" title="Delete">üóëÔ∏è</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function deleteImage(imageId, patientId) {
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete training data image #${imageId} (${patientId})?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                // Call API to delete
                const response = await fetch(`/api/training-data-image/${imageId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete image');
                }
                
                // Success - reload data
                alert(`‚úì Image #${imageId} deleted successfully!`);
                await loadData();
                
            } catch (error) {
                console.error('Error deleting image:', error);
                alert('‚ùå Error deleting image: ' + error.message);
            }
        }
        
        async function showPreview(index) {
            const img = existingData[index];
            const modal = document.getElementById('previewModal');
            const modalImages = document.getElementById('modalImages');
            
            document.getElementById('modalTitle').textContent = `${img.patient_id} - ${img.task_type}`;
            document.getElementById('modalSubtitle').textContent = 
                `Source: ${img.source_format} | Original: ${img.original_filename}`;
            
            // Load features
            let featuresData = {};
            try {
                const response = await fetch(`/api/training-data-image/${img.id}/features`);
                const data = await response.json();
                featuresData = data.features || {};
            } catch (error) {
                console.error('Error loading features:', error);
            }
            
            // For both MAT and OCS: Show Original + Processed
            // MAT: API extracts unoptimized drawing on-the-fly
            // OCS: API returns actual original PNG
            const sourceLabel = img.source_format === 'MAT' 
                ? 'üìä Original Drawing (from .mat)' 
                : 'üì∑ Original Uploaded';
            
            const sourceDesc = img.source_format === 'MAT'
                ? 'Unoptimized drawing from MATLAB file'
                : 'Human rating with red pixels';
            
            const isMAT = img.source_format === 'MAT';
            
            // Add cache buster to force reload
            const cacheBuster = Date.now();
            
            const imagesHtml = `
                <div class="modal-images-row">
                    <div class="modal-image-section">
                        <h3>${sourceLabel}</h3>
                        <img src="/api/training-data-image/${img.id}/original?v=${cacheBuster}" alt="Original">
                        <p style="color: #999; font-size: 0.85em; margin-top: 5px; text-align: center;">
                            ${isMAT ? 'Unoptimized, original thickness' : 'With red pixels and grid'}
                        </p>
                        <div class="image-meta">
                            <p><strong>Image ID:</strong> ${img.id}</p>
                            <p><strong>Patient:</strong> ${img.patient_id}</p>
                            <p><strong>Task:</strong> ${img.task_type}</p>
                            <p><strong>Source:</strong> ${sourceDesc}</p>
                        </div>
                    </div>
                    
                    <div class="modal-image-section">
                        <h3>‚ú® Optimized (CNN-Ready)</h3>
                        <img src="/api/training-data-image/${img.id}/processed?v=${cacheBuster}" 
                             alt="Processed" 
                             style="border: 2px solid #28a745;">
                        <p style="color: #28a745; font-size: 0.85em; margin-top: 5px; text-align: center;">
                            Auto-cropped, normalized, CNN-ready
                        </p>
                        <div class="image-meta">
                            <p><strong>Resolution:</strong> ${img.width}√ó${img.height}px</p>
                            <p><strong>Line Thickness:</strong> 2.00px (normalized)</p>
                            <p><strong>Format:</strong> Black-on-white PNG</p>
                            <p><strong>Auto-cropped:</strong> 5px padding</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Add Feature Editor Section
            const featuresList = Object.keys(featuresData).length > 0
                ? Object.entries(featuresData).map(([key, value]) => {
                    // Escape for HTML display
                    const safeKey = key.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    
                    // Handle Custom_Class differently
                    if (key === 'Custom_Class' && typeof value === 'object') {
                        // Display Custom_Class structure
                        const customClassHtml = Object.entries(value).map(([numClasses, classData]) => {
                            const name = classData.name_custom || classData.name_generic || `Class ${classData.label}`;
                            return `
                                <div class="feature-item" style="margin-left: 20px; border-left: 3px solid #667eea; padding-left: 10px;">
                                    <span class="feature-key">üè∑Ô∏è ${numClasses} Classes</span>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <span class="feature-value" title="Label: ${classData.label}, Range: ${JSON.stringify(classData.boundaries)}">${name}</span>
                                        <span style="color: #999; font-size: 0.85em;">(Label: ${classData.label})</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        return `
                            <div class="feature-item" style="background: #f8f9fa;">
                                <span class="feature-key" style="font-weight: 600;">Custom_Class</span>
                                <span class="feature-value" style="color: #667eea;">${Object.keys(value).length} classification(s)</span>
                            </div>
                            ${customClassHtml}
                        `;
                    }
                    
                    // Regular feature
                    return `
                        <div class="feature-item">
                            <span class="feature-key">${safeKey}</span>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span class="feature-value">${value}</span>
                                <button class="delete-feature-btn" 
                                        data-image-id="${img.id}" 
                                        data-feature-key="${safeKey}" 
                                        style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #999; text-align: center; padding: 10px;">No features set yet</p>';
            
            // Add Ground Truth Editor Section
            const groundTruthEditor = `
                <div class="feature-editor" data-current-image-id="${img.id}" style="margin-bottom: 20px;">
                    <h3>üéØ Ground Truth (for Algorithmic Evaluation)</h3>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #dee2e6;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #28a745;">‚úì Correct Lines (0-11)</label>
                                <input type="number" id="groundTruthCorrect" value="${img.ground_truth_correct || 0}" min="0" max="11" 
                                       style="width: 100%; padding: 8px; border: 1px solid #28a745; border-radius: 4px; background: white;" />
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #ffc107;">‚úó Extra Lines</label>
                                <input type="number" id="groundTruthExtra" value="${img.ground_truth_extra || 0}" min="0" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ffc107; border-radius: 4px; background: white;" />
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em; color: #666;">
                            <strong>Missing Lines:</strong> ${11 - (img.ground_truth_correct || 0)} (calculated: 11 - correct)
                        </div>
                        <button class="btn btn-small save-ground-truth-btn" style="margin-top: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%;">
                            üíæ Save Ground Truth
                        </button>
                    </div>
                </div>
            `;
            
            const featureEditor = `
                <div class="feature-editor" data-current-image-id="${img.id}">
                    <h3>üè∑Ô∏è Features & Labels (for CNN Training)</h3>
                    <div class="feature-list" id="featuresList">
                        ${featuresList}
                    </div>
                    <div class="feature-input-group">
                        <input type="text" id="featureKey" placeholder="Feature name (e.g., quality_score)" />
                        <input type="number" id="featureValue" placeholder="Numeric value (e.g., 0.85)" step="any" />
                        <button class="btn btn-small add-feature-btn" style="white-space: nowrap;">+ Add</button>
                    </div>
                </div>
            `;
            
            modalImages.innerHTML = imagesHtml + groundTruthEditor + featureEditor;
            
            // Add event listeners for buttons (event delegation)
            setTimeout(() => {
                // Save ground truth button
                const saveGroundTruthBtn = document.querySelector('.save-ground-truth-btn');
                if (saveGroundTruthBtn) {
                    saveGroundTruthBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        await saveGroundTruth(img.id);
                    });
                }
                
                // Update missing lines display when correct lines changes
                const correctInput = document.getElementById('groundTruthCorrect');
                if (correctInput) {
                    correctInput.addEventListener('input', (e) => {
                        const correct = parseInt(e.target.value) || 0;
                        const missingDisplay = document.querySelector('.feature-editor div[style*="Missing Lines"]');
                        if (missingDisplay) {
                            missingDisplay.innerHTML = `<strong>Missing Lines:</strong> ${11 - correct} (calculated: 11 - correct)`;
                        }
                    });
                }
                
                // Add feature button
                const addBtn = document.querySelector('.add-feature-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        await addFeature(img.id);
                    });
                }
                
                // Delete feature buttons
                document.querySelectorAll('.delete-feature-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const imageId = parseInt(btn.getAttribute('data-image-id'));
                        const featureKey = btn.getAttribute('data-feature-key');
                        await deleteFeature(imageId, featureKey);
                    });
                });
            }, 0);
            
            modal.classList.add('show');
        }
        
        async function saveGroundTruth(imageId) {
            const correct = parseInt(document.getElementById('groundTruthCorrect').value) || 0;
            const extra = parseInt(document.getElementById('groundTruthExtra').value) || 0;
            
            try {
                const response = await fetch(`/api/training-data-image/${imageId}/ground-truth`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ground_truth_correct: correct,
                        ground_truth_extra: extra
                    })
                });
                
                if (response.ok) {
                    // Reload data and re-open modal
                    await loadData();
                    const newIndex = existingData.findIndex(img => img.id === imageId);
                    if (newIndex >= 0) {
                        showPreview(newIndex);
                    }
                } else {
                    alert('Error saving ground truth');
                }
            } catch (error) {
                console.error('Error saving ground truth:', error);
                alert('Error saving ground truth: ' + error.message);
            }
        }
        
        async function addFeature(imageId) {
            const key = document.getElementById('featureKey').value.trim();
            const value = parseFloat(document.getElementById('featureValue').value);
            
            if (!key || isNaN(value)) {
                alert('Please enter both feature name and numeric value');
                return;
            }
            
            // Get current features
            const response = await fetch(`/api/training-data-image/${imageId}/features`);
            const data = await response.json();
            const features = data.features || {};
            
            // Add new feature
            features[key] = value;
            
            // Save
            await fetch(`/api/training-data-image/${imageId}/features`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(features)
            });
            
            // Reload data and re-open modal
            await loadData();
            const newIndex = existingData.findIndex(img => img.id === imageId);
            if (newIndex >= 0) {
                showPreview(newIndex);
            }
        }
        
        async function deleteFeature(imageId, featureKey) {
            // Get current features
            const response = await fetch(`/api/training-data-image/${imageId}/features`);
            const data = await response.json();
            const features = data.features || {};
            
            // Delete feature
            delete features[featureKey];
            
            // Save
            await fetch(`/api/training-data-image/${imageId}/features`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(features)
            });
            
            // Reload data and re-open modal
            await loadData();
            const newIndex = existingData.findIndex(img => img.id === imageId);
            if (newIndex >= 0) {
                showPreview(newIndex);
            }
        }
        
        function closeModal() {
            document.getElementById('previewModal').classList.remove('show');
        }
        
        function updatePagination() {
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} of ${totalPages || 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1 || totalPages === 0;
            
            // Update items info
            const filteredData = getFilteredData();
            const totalItems = filteredData.length;
            const startItem = currentPage * pageSize + 1;
            const endItem = Math.min((currentPage + 1) * pageSize, totalItems);
            
            if (totalItems > 0) {
                document.getElementById('itemsInfo').textContent = `Showing ${startItem}-${endItem} of ${totalItems} items`;
            } else {
                document.getElementById('itemsInfo').textContent = '';
            }
        }
        
        function changePage(delta) {
            currentPage += delta;
            if (currentPage < 0) currentPage = 0;
            if (currentPage >= totalPages) currentPage = totalPages - 1;
            
            // Re-render with new page (no need to reload from API)
            renderDataTable(getPaginatedData());
            updatePagination();
        }
        
        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            currentPage = 0;  // Reset to first page when changing page size
            
            // Recalculate pagination
            const filteredData = getFilteredData();
            totalPages = Math.ceil(filteredData.length / pageSize);
            
            // Re-render with new page size
            renderDataTable(getPaginatedData());
            updatePagination();
        }
        
        async function uploadFeatureCSV() {
            const fileInput = document.getElementById('csvFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const resultDiv = document.getElementById('csvUploadResult');
            resultDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><p>Processing CSV...</p></div>';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/api/training-data-features-upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 6px;">
                            <strong>‚úÖ Upload Successful!</strong>
                            <p style="margin: 10px 0 0 0;">
                                Updated: ${data.updated} | Skipped: ${data.skipped} | Total: ${data.total_rows}
                            </p>
                            ${data.errors.length > 0 ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer;">Errors (${data.errors.length})</summary>
                                    <ul style="margin: 10px 0 0 20px;">
                                        ${data.errors.map(err => `<li>${err}</li>`).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                    
                    // Reload data
                    await loadData();
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                    }, 8000);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 6px;">
                        <strong>‚ùå Upload Failed</strong>
                        <p style="margin: 10px 0 0 0;">${error.message}</p>
                    </div>
                `;
            } finally {
                fileInput.value = '';
            }
        }
        
        function showAlert(type, message) {
            const alert = document.getElementById('alert');
            alert.className = `alert ${type} show`;
            alert.textContent = message;
            setTimeout(() => alert.classList.remove('show'), 8000);
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>

