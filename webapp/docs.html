<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPSketch - Documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .markdown-body h1 {
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .markdown-body h2 {
            margin-top: 30px;
            color: #667eea;
        }
        
        .markdown-body a {
            color: #667eea;
        }
        
        .markdown-body code {
            background: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .markdown-body pre {
            background: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
        }
        
        .markdown-body table {
            width: 100%;
        }
        
        .markdown-body blockquote {
            border-left: 4px solid #667eea;
        }
        
        @media (max-width: 767px) {
            .markdown-body {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/index.html" class="back-link">â† Back to Home</a>
        
        <article class="markdown-body">
            <h1>NPSketch v1.0</h1>
            <p><strong>Automated Line Detection for Hand-Drawn Images</strong></p>
            <p>NPSketch is a computer vision application that automatically compares hand-drawn images to reference templates, providing detailed feedback on drawing accuracy.</p>
            
            <hr>
            
            <h2>ğŸ¯ Motivation</h2>
            <p>The goal of this project is to create an automated solution for comparing hand-drawn images â€” for example, the "House of Nikolaus" â€” to a reference drawing. The system automatically identifies how many lines in the drawing are correct, missing, or misplaced, and provides both numerical and visual feedback.</p>
            
            <hr>
            
            <h2>âœ¨ Features</h2>
            <ul>
                <li><strong>Automated Line Detection</strong>: Uses OpenCV Hough Transform to detect and extract line features from drawings</li>
                <li><strong>Smart Comparison</strong>: Compares uploaded drawings to reference templates with configurable tolerance</li>
                <li><strong>Visual Feedback</strong>: Generates side-by-side visualizations showing matches and differences</li>
                <li><strong>REST API</strong>: Full-featured FastAPI backend with automatic documentation</li>
                <li><strong>Modern Web Interface</strong>: Beautiful, responsive web UI with drag & drop upload</li>
                <li><strong>Database Storage</strong>: SQLite database for storing images, features, and evaluation results</li>
                <li><strong>Persistent Data</strong>: Volume-mounted data directory for database and visualizations</li>
                <li><strong>Hot Reload</strong>: Development mode with automatic code reloading</li>
            </ul>
            
            <hr>
            
            <h2>ğŸ—ï¸ Architecture</h2>
            <pre><code>npsketch/
â”œâ”€â”€ data/                         # Persistent data (volume mounted)
â”‚   â”œâ”€â”€ npsketch.db              # SQLite database
â”‚   â”œâ”€â”€ visualizations/          # Generated comparison images
â”‚   â””â”€â”€ .gitignore               # Ignore DB & visualizations
â”œâ”€â”€ api/                          # FastAPI Backend
â”‚   â”œâ”€â”€ main.py                  # Main application with endpoints
â”‚   â”œâ”€â”€ database.py              # SQLAlchemy models and setup
â”‚   â”œâ”€â”€ models.py                # Pydantic request/response models
â”‚   â”œâ”€â”€ image_processing/        # Image processing library
â”‚   â”‚   â”œâ”€â”€ line_detector.py     # Line detection using Hough Transform
â”‚   â”‚   â”œâ”€â”€ comparator.py        # Line comparison and similarity metrics
â”‚   â”‚   â””â”€â”€ utils.py             # Image preprocessing utilities
â”‚   â”œâ”€â”€ services/                # Business logic layer
â”‚   â”‚   â”œâ”€â”€ reference_service.py # Reference image management
â”‚   â”‚   â””â”€â”€ evaluation_service.py# Evaluation workflow
â”‚   â”œâ”€â”€ requirements.txt         # Python dependencies
â”‚   â””â”€â”€ Dockerfile               # API container definition
â”œâ”€â”€ webapp/                      # Frontend (served by nginx)
â”‚   â”œâ”€â”€ index.html               # Landing page
â”‚   â”œâ”€â”€ app.html                 # Main application
â”‚   â”œâ”€â”€ upload.html              # Upload interface
â”‚   â”œâ”€â”€ reference.html           # Reference image viewer
â”‚   â”œâ”€â”€ evaluations.html         # Evaluations browser
â”‚   â””â”€â”€ draw_testimage.html      # Test image creator
â”œâ”€â”€ nginx/                       # Nginx configuration
â”‚   â””â”€â”€ nginx.conf               # Reverse proxy config
â”œâ”€â”€ docker-compose.yml           # Container orchestration
â”œâ”€â”€ .gitignore                   # Git ignore rules
â””â”€â”€ README.md                    # Documentation
</code></pre>
            
            <h3>Communication Flow</h3>
            <pre><code>Browser â†’ nginx (Port 80) â†’ Static HTML files (webapp/)
        â†“
        JavaScript â†’ /api/* â†’ nginx â†’ FastAPI (Port 8000)
        â†“
        Response with JSON data
</code></pre>
            
            <hr>
            
            <h2>ğŸš€ Quick Start</h2>
            
            <h3>Prerequisites</h3>
            <ul>
                <li>Docker and Docker Compose</li>
                <li>(Optional) Python 3.10+ for local development</li>
            </ul>
            
            <h3>Installation & Running</h3>
            <ol>
                <li><strong>Clone or navigate to the project directory:</strong>
                    <pre><code>cd npsketch</code></pre>
                </li>
                <li><strong>Start the application:</strong>
                    <pre><code>docker compose up --build -d</code></pre>
                </li>
                <li><strong>Access the application:</strong>
                    <ul>
                        <li><strong>Landing Page</strong>: <a href="http://localhost">http://localhost</a></li>
                        <li><strong>Main Application</strong>: <a href="/app.html">http://localhost/app.html</a></li>
                        <li><strong>Upload Interface</strong>: <a href="/upload.html">http://localhost/upload.html</a></li>
                        <li><strong>Reference Image</strong>: <a href="/reference.html">http://localhost/reference.html</a></li>
                        <li><strong>Evaluations</strong>: <a href="/evaluations.html">http://localhost/evaluations.html</a></li>
                        <li><strong>Draw Test Image</strong>: <a href="/draw_testimage.html">http://localhost/draw_testimage.html</a></li>
                        <li><strong>API Documentation</strong>: <a href="http://localhost/api/docs" target="_blank">http://localhost/api/docs</a></li>
                    </ul>
                </li>
                <li><strong>Stop the application:</strong>
                    <pre><code>docker compose down</code></pre>
                </li>
            </ol>
            
            <hr>
            
            <h2>ğŸ“– How It Works</h2>
            
            <h3>1. Reference Image Initialization</h3>
            <p>On startup, the system:</p>
            <ul>
                <li>Checks if the SQLite database exists, otherwise initializes it</li>
                <li>Loads the reference image (from <code>templates/reference_image.png</code> or generates default pattern)</li>
                <li>Normalizes the reference to 256Ã—256 pixels</li>
                <li>Uses OpenCV to extract exactly 8 line features</li>
                <li>Stores extracted reference features and images in the database</li>
            </ul>
            
            <h3>2. Image Upload & Processing</h3>
            <p>When you upload an image:</p>
            <ol>
                <li><strong>Normalization</strong>: Image is resized to 256Ã—256 with aspect ratio preservation and padding</li>
                <li><strong>Preprocessing</strong>: Converted to grayscale, Gaussian blur applied, adaptive thresholding</li>
                <li><strong>Line Detection</strong>: Probabilistic Hough Transform detects line segments</li>
                <li><strong>Line Merging</strong>: Similar lines are merged to reduce duplicates</li>
                <li><strong>Feature Extraction</strong>: Lines, angles, and lengths are extracted and stored</li>
                <li><strong>Storage</strong>: Original and processed images stored in database</li>
            </ol>
            
            <h3>3. Comparison & Evaluation</h3>
            <p>The system compares detected lines to reference lines using:</p>
            <ul>
                <li><strong>Position Similarity</strong>: Euclidean distance between line midpoints (tolerance: 20px)</li>
                <li><strong>Angle Similarity</strong>: Angle difference in degrees (tolerance: 15Â°)</li>
                <li><strong>Length Similarity</strong>: Relative length ratio (tolerance: 30%)</li>
                <li><strong>Weighted Similarity</strong>: Combines metrics (40% position, 30% angle, 30% length)</li>
            </ul>
            
            <p>Metrics calculated:</p>
            <ul>
                <li><strong>Correct Lines</strong>: Lines that match the reference (similarity &gt; 70%)</li>
                <li><strong>Missing Lines</strong>: Reference lines not found in drawing</li>
                <li><strong>Extra Lines</strong>: Lines drawn but not in reference</li>
                <li><strong>Similarity Score</strong>: Overall accuracy (0-100%)</li>
            </ul>
            
            <h3>4. Visualization</h3>
            <p>Each evaluation generates a side-by-side visualization:</p>
            <ul>
                <li>ğŸŸ¢ <strong>Green</strong>: Matched lines (present in both)</li>
                <li>ğŸ”´ <strong>Red</strong>: Missing lines (in reference only)</li>
                <li>ğŸ”µ <strong>Blue</strong>: Extra lines (in upload only)</li>
            </ul>
            
            <hr>
            
            <h2>ğŸ”§ Configuration</h2>
            
            <h3>Line Detection Parameters</h3>
            <p>Edit <code>api/image_processing/line_detector.py</code>:</p>
            <pre><code>LineDetector(
    rho=1.0,              # Distance resolution (pixels)
    theta=np.pi/180,      # Angle resolution (radians)
    threshold=100,        # Minimum votes for line
    min_line_length=80,   # Minimum line length (pixels)
    max_line_gap=25       # Max gap between segments (pixels)
)</code></pre>
            
            <h3>Line Merging</h3>
            <pre><code>_merge_similar_lines(
    position_threshold=15.0,  # Max distance for merge (pixels)
    angle_threshold=8.0       # Max angle for merge (degrees)
)</code></pre>
            
            <h3>Comparison Tolerance</h3>
            <p>Edit <code>api/image_processing/comparator.py</code>:</p>
            <pre><code>LineComparator(
    position_tolerance=20.0,  # Max position difference (pixels)
    angle_tolerance=15.0,     # Max angle difference (degrees)
    length_tolerance=0.3      # Max length difference (ratio)
)</code></pre>
            
            <hr>
            
            <h2>ğŸ“¡ API Endpoints</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>Method</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/api/health</code></td>
                        <td>GET</td>
                        <td>Health check and stats</td>
                    </tr>
                    <tr>
                        <td><code>/api/upload</code></td>
                        <td>POST</td>
                        <td>Upload and evaluate image</td>
                    </tr>
                    <tr>
                        <td><code>/api/evaluations/recent</code></td>
                        <td>GET</td>
                        <td>List recent evaluations</td>
                    </tr>
                    <tr>
                        <td><code>/api/evaluations/{id}</code></td>
                        <td>GET</td>
                        <td>Get specific evaluation</td>
                    </tr>
                    <tr>
                        <td><code>/api/references</code></td>
                        <td>GET</td>
                        <td>List reference images</td>
                    </tr>
                    <tr>
                        <td><code>/api/references/{id}/image</code></td>
                        <td>GET</td>
                        <td>Get reference image data</td>
                    </tr>
                    <tr>
                        <td><code>/api/references/{id}/features</code></td>
                        <td>GET</td>
                        <td>Get reference features</td>
                    </tr>
                    <tr>
                        <td><code>/api/test-images</code></td>
                        <td>GET/POST</td>
                        <td>Manage test images</td>
                    </tr>
                    <tr>
                        <td><code>/api/visualizations/{file}</code></td>
                        <td>GET</td>
                        <td>Get visualization image</td>
                    </tr>
                </tbody>
            </table>
            
            <p>For interactive API documentation, visit: <a href="/api/docs" target="_blank">http://localhost/api/docs</a></p>
            
            <hr>
            
            <h2>ğŸ§ª Testing</h2>
            
            <h3>Manual Testing</h3>
            <ol>
                <li>Navigate to <a href="/upload.html">Upload Interface</a></li>
                <li>Drag and drop or click to upload a hand-drawn image</li>
                <li>View instant feedback with metrics and visualization</li>
            </ol>
            
            <h3>Creating Test Images</h3>
            <ol>
                <li>Go to <a href="/draw_testimage.html">Draw Test Image</a></li>
                <li>Draw on the 256Ã—256 canvas</li>
                <li>Enter expected scores manually</li>
                <li>Save to database for regression testing</li>
            </ol>
            
            <hr>
            
            <h2>ğŸ³ Docker Details</h2>
            
            <h3>Services</h3>
            <ul>
                <li><strong>nginx</strong>: Serves frontend (webapp/) and proxies API requests (Port 80)</li>
                <li><strong>api</strong>: FastAPI backend with OpenCV (Port 8000)</li>
            </ul>
            
            <h3>Volumes</h3>
            <ul>
                <li><code>./api:/app:rw</code> - API code (hot-reload enabled)</li>
                <li><code>./data:/app/data:rw</code> - Persistent data (database & visualizations)</li>
                <li><code>./templates:/app/templates:ro</code> - Reference image template</li>
                <li><code>./webapp:/usr/share/nginx/html:ro</code> - Frontend files</li>
                <li><code>./nginx/nginx.conf:/etc/nginx/nginx.conf:ro</code> - Nginx configuration</li>
            </ul>
            
            <h3>Useful Commands</h3>
            <pre><code># Rebuild after code changes
docker compose up --build

# View logs
docker compose logs -f api

# Restart services
docker compose restart

# Clean rebuild
docker compose down
docker compose up --build -d
</code></pre>
            
            <hr>
            
            <h2>ğŸ” Algorithms Used</h2>
            
            <h3>Line Detection</h3>
            <ul>
                <li><strong>Gaussian Blur</strong>: Reduces noise before edge detection</li>
                <li><strong>Adaptive Thresholding</strong>: Converts to binary image</li>
                <li><strong>Probabilistic Hough Transform</strong>: Detects line segments efficiently</li>
                <li><strong>Line Merging Algorithm</strong>: Consolidates similar lines based on position and angle</li>
            </ul>
            
            <h3>Comparison Algorithm</h3>
            <ul>
                <li><strong>Euclidean Distance</strong>: For position matching (line midpoints)</li>
                <li><strong>Angular Distance</strong>: For orientation matching (line angles)</li>
                <li><strong>Length Ratio</strong>: For size matching (relative lengths)</li>
                <li><strong>Weighted Similarity</strong>: Combines all metrics with configurable weights</li>
                <li><strong>Greedy Matching</strong>: Finds best matches between detected and reference lines</li>
            </ul>
            
            <hr>
            
            <h2>ğŸ“Š Database Schema</h2>
            
            <h3>Tables</h3>
            <ol>
                <li><strong>reference_images</strong> - Reference templates and features</li>
                <li><strong>uploaded_images</strong> - User-uploaded drawings</li>
                <li><strong>extracted_features</strong> - Detected line features</li>
                <li><strong>evaluation_results</strong> - Comparison results and scores</li>
                <li><strong>test_images</strong> - Manual test images with expected scores</li>
            </ol>
            
            <p>Database file: <code>data/npsketch.db</code> (SQLite)</p>
            
            <hr>
            
            <h2>ğŸ‘¤ Author</h2>
            <p><strong>ste</strong><br>
            Date: October 2025<br>
            Version: 1.0</p>
            
            <hr>
            
            <p style="text-align: center; margin-top: 40px; font-size: 24px;"><strong>Happy Sketching! ğŸ¨</strong></p>
        </article>
    </div>
</body>
</html>

